
## Testing

``` sh
pytest --color=yes
```


## To build and deploy
There are two steps - building an artifact and deploying it to AWS.
Building the artifact happens first in a separate step, because we need to 
install specific libraries that are compatible with AWS's Lambda runners.

From the root directory

``` sh
./bin/build-aws-artifact.sh

cd iac
terraform apply
```

## Manual testing
Navigate to the AWS Lambda that's been set up and go to the "Test" section.

Use the `apigateway-authorizer` template and replace the `authorizationToken`
with one that has been generated by the keycloak.andrewslai.com Identity
provider. This token is sent with all requests to the kaleidoscope backend, and
can be sniffed from network requests at `andrewslai.com`.


# API Gateway authorizer responses
The primary use of this Lambda is as an API Gateway authorizer. Unfortunately,
AWS API Gateway responses are poorly documented, and difficult to understand.

When API Gateway receives a response from this Lambda, it will use the `context`
fields in the Lambda's output and make them available for potential use by the
API GW. 

By default, when you set up an API Gateway, there is a Mapping that translates
data from your Lambda output into an HTTP response. This can be found under "API
Gateway" -> "go-test-gateway" -> Gateway Responses that shows how error messages
are translated to the user. For example, under "Access Denied" the default is
`{"message":$context.error.messageString}`, indicating that the messageString
will be returned to the user. 

Thus, the key is to know how the `context` object is created from a Lambda
response. In the case of an API Gateway authorizer, if the Lamda returns 

``` json
{
  "context": {
    "a": "b"
  }
}
```
then the context object will be available to the API Gateway responses under `"$context.authorizer.PROPERTY-NAME"`. 
In our example, "a" will be available under `"$context.authorizer.a"`.

This Lambda returns custom fields in the context with more details about the
authorization error.  However, it is the consumer's responsibility to update the
API Gateway Responses to make use of the context variables.

See the AWS documentation on context variables for more details.
https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html#context-variable-reference

https://stackoverflow.com/questions/47921803/how-to-throw-custom-error-message-from-api-gateway-custom-authorizer
https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html
https://repost.aws/questions/QUgItZ7VFcS1iQ5wKGeU4YqA/is-it-possible-to-throw-custom-error-message-from-api-gateway-lambda-authorizer
https://stackoverflow.com/a/49806967

# Notes
Docs for PyJWT
https://pyjwt.readthedocs.io/en/latest/usage.html

Generating test RSA keys
https://gist.github.com/ygotthilf/baa58da5c3dd1f69fae9

Need to install the correct version of Cryptography because only a specific version is compatible with AWS
https://github.com/pyca/cryptography/issues/6391#issue-1020088939
